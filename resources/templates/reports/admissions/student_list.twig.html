<!-- Individual Student List Table -->
<div class="overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Student
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Program
                    </th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Start Date
                    </th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Expected Graduation
                    </th>
                    {% if 'address' in selectedOptionalFields %}
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Address
                    </th>
                    {% endif %}
                    {% if 'demographics' in selectedOptionalFields %}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Demographics
                    </th>
                    {% endif %}
                    {% if 'emergency' in selectedOptionalFields %}
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Emergency Contact
                    </th>
                    {% endif %}
                    {% if 'financial' in selectedOptionalFields %}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Total Paid
                    </th>
                    {% endif %}
                    {% if 'employment' in selectedOptionalFields %}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Employment
                    </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for student in reportData %}
                <tr class="hover:bg-gray-50">
                    <!-- Student Information -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <span class="text-sm font-medium text-indigo-600">
                                        {{ student.firstName[:1] }}{{ student.lastName[:1] }}
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ student.firstName }} {{ student.lastName }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    ID: {{ student.studentID }}
                                </div>
                                {% if student.email %}
                                <div class="text-xs text-gray-400">
                                    {{ student.email }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>

                    <!-- Program -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ student.programName }}</div>
                        <div class="text-sm text-gray-500">{{ student.programCode }}</div>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                            {% if student.status == 'Active' %}bg-green-100 text-green-800
                            {% elseif student.status == 'Graduated' %}bg-blue-100 text-blue-800
                            {% elseif student.status == 'Prospective' %}bg-yellow-100 text-yellow-800
                            {% elseif student.status == 'Withdrawn' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ student.status }}
                        </span>
                    </td>

                    <!-- Start Date -->
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        {% if student.startDate %}
                            {{ student.startDate | date('M j, Y') }}
                        {% else %}
                            <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>

                    <!-- Expected Graduation -->
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        {% if student.expectedGraduationDate %}
                            {{ student.expectedGraduationDate | date('M j, Y') }}
                        {% elseif student.actualGraduationDate %}
                            <div class="text-blue-600 font-medium">
                                {{ student.actualGraduationDate | date('M j, Y') }}
                            </div>
                            <div class="text-xs text-blue-500">Graduated</div>
                        {% else %}
                            <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>

                    <!-- Optional: Address -->
                    {% if 'address' in selectedOptionalFields %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if student.address %}
                        <div class="text-sm text-gray-900">{{ student.address }}</div>
                        <div class="text-sm text-gray-500">
                            {{ student.city }}{% if student.state %}, {{ student.state }}{% endif %}
                            {% if student.zipCode %} {{ student.zipCode }}{% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Optional: Demographics -->
                    {% if 'demographics' in selectedOptionalFields %}
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        {% if student.dateOfBirth %}
                        <div class="text-sm text-gray-900">
                            {{ student.dateOfBirth | date('M j, Y') }}
                        </div>
                        <div class="text-xs text-gray-500">
                            Age: {{ date().diff(date(student.dateOfBirth)).y }}
                        </div>
                        {% endif %}
                        {% if student.gender %}
                        <div class="text-xs text-gray-500 mt-1">
                            {{ student.gender }}
                        </div>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Optional: Emergency Contact -->
                    {% if 'emergency' in selectedOptionalFields %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if student.emergencyContactName %}
                        <div class="text-sm text-gray-900">{{ student.emergencyContactName }}</div>
                        {% if student.emergencyContactPhone %}
                        <div class="text-sm text-gray-500">{{ student.emergencyContactPhone }}</div>
                        {% endif %}
                        {% else %}
                        <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Optional: Financial -->
                    {% if 'financial' in selectedOptionalFields %}
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        {% if student.totalPaid %}
                        <div class="text-sm font-medium text-green-600">
                            ${{ student.totalPaid | number_format(2) }}
                        </div>
                        {% else %}
                        <span class="text-gray-400">$0</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Optional: Employment -->
                    {% if 'employment' in selectedOptionalFields %}
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        {% if student.employmentStatus %}
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                            {% if student.employmentStatus in ['employed_related', 'employed_unrelated', 'self_employed_related', 'self_employed_unrelated'] %}bg-green-100 text-green-800
                            {% elseif student.employmentStatus == 'not_employed_seeking' %}bg-yellow-100 text-yellow-800
                            {% elseif student.employmentStatus == 'continuing_education' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% if student.employmentStatus == 'employed_related' %}Employed (Field-Related)
                            {% elseif student.employmentStatus == 'employed_unrelated' %}Employed (Unrelated)
                            {% elseif student.employmentStatus == 'self_employed_related' %}Self-Employed (Field-Related)
                            {% elseif student.employmentStatus == 'self_employed_unrelated' %}Self-Employed (Unrelated)
                            {% elseif student.employmentStatus == 'not_employed_seeking' %}Job Seeking
                            {% elseif student.employmentStatus == 'not_employed_not_seeking' %}Not Seeking Employment
                            {% elseif student.employmentStatus == 'continuing_education' %}Continuing Education
                            {% else %}{{ student.employmentStatus }}{% endif %}
                        </span>
                        {% if student.employerName %}
                        <div class="text-xs text-gray-500 mt-1">{{ student.employerName }}</div>
                        {% endif %}
                        {% else %}
                        <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="100%" class="px-6 py-4 text-center text-gray-500">
                        No students found matching the selected criteria.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Student List Summary -->
{% if reportData | length > 0 %}
<div class="mt-6 bg-gray-50 rounded-lg p-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
        {% set statusCounts = {} %}
        {% for student in reportData %}
            {% set status = student.status %}
            {% set statusCounts = statusCounts | merge({(status): (statusCounts[status] | default(0)) + 1}) %}
        {% endfor %}

        {% for status, count in statusCounts %}
        <div class="bg-white rounded-lg p-3 shadow-sm">
            <div class="text-lg font-semibold
                {% if status == 'Active' %}text-green-600
                {% elseif status == 'Graduated' %}text-blue-600
                {% elseif status == 'Prospective' %}text-yellow-600
                {% elseif status == 'Withdrawn' %}text-red-600
                {% else %}text-gray-600{% endif %}">
                {{ count | number_format }}
            </div>
            <div class="text-sm text-gray-500">{{ status }}</div>
            <div class="text-xs text-gray-400">
                {{ ((count / (reportData | length)) * 100) | number_format(1) }}%
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Optional Fields Legend -->
{% if selectedOptionalFields | length > 0 %}
<div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
    <div class="text-sm font-medium text-blue-800 mb-2">Optional Fields Included:</div>
    <div class="flex flex-wrap gap-2">
        {% for field in selectedOptionalFields %}
        <span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
            {% if field == 'address' %}Address Information
            {% elseif field == 'demographics' %}Demographics (DOB, Gender)
            {% elseif field == 'emergency' %}Emergency Contact
            {% elseif field == 'financial' %}Financial Summary
            {% elseif field == 'employment' %}Employment Status
            {% else %}{{ field | title }}{% endif %}
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}